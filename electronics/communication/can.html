<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CAN - Ecam Eurobot</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <base href="../../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="_FontAwesome/css/font-awesome.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="introduction.html">Introduction</a></li><li><a href="graphic/graphic_chart.html"><strong aria-hidden="true">1.</strong> Graphic chart</a></li><li><a href="mechanical/mechanical.html"><strong aria-hidden="true">2.</strong> Mechanical</a></li><li><ol class="section"><li><a href="mechanical/fusion.html"><strong aria-hidden="true">2.1.</strong> 3D modeling with Fusion360</a></li><li><a href="mechanical/3d-print.html"><strong aria-hidden="true">2.2.</strong> 3D printing</a></li><li><a href="mechanical/mecanum.html"><strong aria-hidden="true">2.3.</strong> Mecanum wheels</a></li><li><a href="mechanical/2018/lift.html"><strong aria-hidden="true">2.4.</strong> 2018 specifics</a></li><li><ol class="section"><li><a href="mechanical/2018/bigRobot.html"><strong aria-hidden="true">2.4.1.</strong> Block mechanism</a></li><li><a href="mechanical/2018/balls.html"><strong aria-hidden="true">2.4.2.</strong> Ball mechanism</a></li></ol></li></ol></li><li><a href="electronics/electronics.html"><strong aria-hidden="true">3.</strong> Electronics</a></li><li><ol class="section"><li><a href="electronics/actuators/actuators.html"><strong aria-hidden="true">3.1.</strong> Actuators</a></li><li><ol class="section"><li><a href="electronics/actuators/dynamixels.html"><strong aria-hidden="true">3.1.1.</strong> Dynamixels</a></li></ol></li><li><a href="electronics/sensors/sensors.html"><strong aria-hidden="true">3.2.</strong> Sensors</a></li><li><ol class="section"><li><a href="electronics/sensors/sonar.html"><strong aria-hidden="true">3.2.1.</strong> Sonar</a></li></ol></li><li><a href="electronics/pcb.html"><strong aria-hidden="true">3.3.</strong> PCB Design</a></li><li><a href="electronics/fpga.html"><strong aria-hidden="true">3.4.</strong> FPGA</a></li><li><a href="electronics/communication/communication.html"><strong aria-hidden="true">3.5.</strong> Communication</a></li><li><ol class="section"><li><a href="electronics/communication/i2c.html"><strong aria-hidden="true">3.5.1.</strong> I2C</a></li><li><a href="electronics/communication/spi.html"><strong aria-hidden="true">3.5.2.</strong> SPI</a></li><li><a href="electronics/communication/can.html" class="active"><strong aria-hidden="true">3.5.3.</strong> CAN</a></li></ol></li></ol></li><li><a href="software/software.html"><strong aria-hidden="true">4.</strong> Software</a></li><li><ol class="section"><li><a href="software/ros/ros.html"><strong aria-hidden="true">4.1.</strong> ROS</a></li><li><ol class="section"><li><a href="software/ros/install.html"><strong aria-hidden="true">4.1.1.</strong> Install</a></li><li><a href="software/ros/basics/basics.html"><strong aria-hidden="true">4.1.2.</strong> Basic concepts</a></li><li><ol class="section"><li><a href="software/ros/basics/workspace.html"><strong aria-hidden="true">4.1.2.1.</strong> Workspace setup</a></li><li><a href="software/ros/basics/packages.html"><strong aria-hidden="true">4.1.2.2.</strong> Packages</a></li><li><a href="software/ros/basics/pub.html"><strong aria-hidden="true">4.1.2.3.</strong> Publisher</a></li><li><a href="software/ros/basics/sub.html"><strong aria-hidden="true">4.1.2.4.</strong> Subscriber</a></li><li><a href="software/ros/basics/launch.html"><strong aria-hidden="true">4.1.2.5.</strong> Launchfiles</a></li><li><a href="software/ros/basics/params.html"><strong aria-hidden="true">4.1.2.6.</strong> ROS parameters</a></li></ol></li><li><a href="software/ros/advanced/advanced.html"><strong aria-hidden="true">4.1.3.</strong> Advanced concepts</a></li><li><ol class="section"><li><a href="software/ros/advanced/custom-msgs.html"><strong aria-hidden="true">4.1.3.1.</strong> Custom messages</a></li><li><a href="software/ros/advanced/model.html"><strong aria-hidden="true">4.1.3.2.</strong> Robot model</a></li><li><a href="software/ros/advanced/rviz.html"><strong aria-hidden="true">4.1.3.3.</strong> Rviz</a></li></ol></li><li><a href="software/ros/rosserial.html"><strong aria-hidden="true">4.1.4.</strong> ROS and Arduino</a></li><li><ol class="section"><li><a href="software/ros/arduino/publisher.html"><strong aria-hidden="true">4.1.4.1.</strong> Publisher</a></li><li><a href="software/ros/arduino/subscriber.html"><strong aria-hidden="true">4.1.4.2.</strong> Subscriber</a></li></ol></li><li><a href="software/ros/packages/packages.html"><strong aria-hidden="true">4.1.5.</strong> Useful packages</a></li><li><ol class="section"><li><a href="software/ros/packages/map.html"><strong aria-hidden="true">4.1.5.1.</strong> Map Server</a></li><li><a href="software/ros/packages/nav.html"><strong aria-hidden="true">4.1.5.2.</strong> Navigation stack</a></li></ol></li></ol></li><li><a href="software/image-processing.html"><strong aria-hidden="true">4.2.</strong> Image processing</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Ecam Eurobot</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="electronics/communication/can.html#why-using-canbus-on-the-robots-and-how-to-implement-it" id="why-using-canbus-on-the-robots-and-how-to-implement-it"><h1>Why using CANBus on the robots and how to implement it</h1></a>
<a class="header" href="electronics/communication/can.html#issues-and-context-of-the-eurobot--2018-" id="issues-and-context-of-the-eurobot--2018-"><h2>Issues and context of the Eurobot ( 2018 )</h2></a>
<p>Many technologies have been implemented on the robots for the 2018 edition of the EUROBOT.</p>
<p>Those technologies were a huge step forward in terms of quality, speed and ease of use.</p>
<p>However, unexpected downsides appeared during the implementation of the technologies on the robots.</p>
<p>Thoses downsides are of all type but those who are speaking about during this tutorial are *<em>electronic</em> and <strong>space</strong>.</p>
<p><img src="electronics/communication/CAN_SRC/complex-wiring.png" alt="alt text" title="Logo Title Text 1" /></p>
<a class="header" href="electronics/communication/can.html#electronic-problem" id="electronic-problem"><h3>Electronic problem</h3></a>
<p>Once the boards are installend on the robots, they needed a lot of connections between them. The last picture shows the kind of result we got after connecting all the wires.</p>
<p>From that moment it is very complex to add or remove wires because of the big amount of cables.</p>
<p>It is also very complex for the debugging because it is hard to take measures and to find where the error is.</p>
<a class="header" href="electronics/communication/can.html#space-problem" id="space-problem"><h3>Space problem</h3></a>
<p>Another problem wich appeared and that we didn't is the huge space taken by the wires.</p>
<p>During the conception the <strong>mistake</strong> we did is to disregard the size of the wires. In the future, some leeway should be taken on the size of the robot during the conception.</p>
<p>The huge number of wires had also an mechanical impact. It added constraint on the connexions wich often broke.</p>
<a class="header" href="electronics/communication/can.html#le-canbus" id="le-canbus"><h2>Le CANBus</h2></a>
<a class="header" href="electronics/communication/can.html#context" id="context"><h3>Context</h3></a>
<p>Those problems have already been met many years ago in the automotive. Indeed, more and more electronic devises were used in the cars for differents purposes :</p>
<ul>
<li>Engine temperature, air...</li>
<li>RPM, speed...</li>
<li>accelerometer...</li>
<li>Safety, ABS, Airbag, opened doors, seatbelt...</li>
</ul>
<a class="header" href="electronics/communication/can.html#specifications" id="specifications"><h3>Specifications</h3></a>
<p>We can cleary see that with the number of wires increasing the wiring harness became a real problem.</p>
<p>To resolve this, BOSCH developped the CANBus with several caracteristics :</p>
<ul>
<li>High speed communication up to 1 Megabit/s (see the table below for more information)</li>
<li>Real time ( wich makes CANBus better than TCP/IP)</li>
<li>Error detection, fast recovery and repair ( stil in real time)</li>
<li>Security and stability</li>
<li>Priorization of transmission</li>
<li>Based on a differiental signal, the CANBus is made for harsh environnements (External noises and fault tolerance)</li>
<li>It uses a twisted pair cable wich limits the noise emition</li>
</ul>
<p>You can see below the speed transmission according to the distances</p>
<p><img src="electronics/communication/CAN_SRC/can_speed.PNG" alt="alt text" /></p>
<a class="header" href="electronics/communication/can.html#topology" id="topology"><h4>Topology</h4></a>
<p>Finally, the biggest benefit of the CANBus is his one bus line topology which limits the number of cables to 4. (CAN HIGH, CAN LOW, VCC and GROUND).</p>
<p>This the reason why it is used on every modern car.</p>
<p><img src="electronics/communication/CAN_SRC/can_topology.png" alt="alt text" /></p>
<p>We can see on the last figure a system without the CANBus (left) and a system with the CANBus (right).</p>
<p>Every component, called a node, is connected to the bus line like the figure below :</p>
<p><img src="electronics/communication/CAN_SRC/can_busnode.jpg" alt="alt text" /></p>
<p>By analogy, the CANBus can be represented by a number of people ( the nodes ) in a room ( the bus line ) where everybody screams his informations. Everyelse has the choice to listen or not. A priority system chooses who is going to speak when several people want to speak at the same time.</p>
<a class="header" href="electronics/communication/can.html#the-frame" id="the-frame"><h3>The frame</h3></a>
<p><img src="electronics/communication/CAN_SRC/can_frame.jpg" alt="alt text" /></p>
<p>A data frame is made of different parts :</p>
<ul>
<li>1 dominant bit begins the frame</li>
<li>The ID of the message is made of 11 bits in the standart CAN or 29 bits in the extended CAN.</li>
<li>6 bits which determine the lenght of the frame</li>
<li>The data made of 0...8 bytes</li>
<li>15 bits of CRC to detect errors</li>
<li>ACK</li>
<li>End of frame bit</li>
</ul>
<a class="header" href="electronics/communication/can.html#priority-of-transmission" id="priority-of-transmission"><h3>Priority of transmission</h3></a>
<p>When differents nodes whant to talk at the same time on the bus line, it is the ID who is going to determine the priority.</p>
<p>It gives an important advantage to CANBus, it is possible to make priority of transmission by choosing the right ID. For example, in car the brake system is more important than the light system. The ID of the brake system will be lower ( more 0 ) than the light system.</p>
<a class="header" href="electronics/communication/can.html#implementation" id="implementation"><h2>Implementation</h2></a>
<a class="header" href="electronics/communication/can.html#hardware" id="hardware"><h3>Hardware</h3></a>
<p><img src="electronics/communication/CAN_SRC/can_hardware.png" alt="alt text" /></p>
<p>The last figure shows the implementation of the CANBus. The implementation is quite easy because of the modules proposed by Microchip.</p>
<p>A node is made of a transceiver, a CAN controller and a microcontroller.</p>
<a class="header" href="electronics/communication/can.html#transceiver" id="transceiver"><h4>Transceiver</h4></a>
<p>Microchip proposes a lot of solutions for the automotive including a transceiver.</p>
<p>It is the MCP2562. Formerly the MCP2551, is used to convert the TTL signal to a differential signal required by the CANBus.</p>
<a class="header" href="electronics/communication/can.html#controller" id="controller"><h4>Controller</h4></a>
<p>Microchip also proposes the CAN controller MCP2515 which implements all the CAN 2.0 specifications. It is able to send and receive data and communicate it via SPI to a microcontroller.</p>
<a class="header" href="electronics/communication/can.html#microcontroller" id="microcontroller"><h4>Microcontroller.</h4></a>
<p>Any microcontroller with an integrated SPI communication can be selected.</p>
<p>For example we can take the famous ATMEGA328p known for his arduino IDE.</p>
<a class="header" href="electronics/communication/can.html#resistance" id="resistance"><h4>Resistance</h4></a>
<p>In every communication wire there is some reflexion that can corrupt the data. It can be avoided by using 120 Ohm resistor at the end of line.</p>
<a class="header" href="electronics/communication/can.html#pcb" id="pcb"><h4>PCB</h4></a>
<p>Coming soon.</p>
<a class="header" href="electronics/communication/can.html#software-arduino" id="software-arduino"><h3>Software (Arduino)</h3></a>
<p>There are many libraries that propose functions to interract with the CAN controller via SPI from the micrcontroller.</p>
<p>A very comlete and up to date library is the Seed studio lib :
<a href="https://github.com/Seeed-Studio/CAN_BUS_Shield">https://github.com/Seeed-Studio/CAN_BUS_Shield</a></p>
<a class="header" href="electronics/communication/can.html#filters" id="filters"><h4>Filters</h4></a>
<p>Filters allow to choose wich messages will be sent to the microcontroller from the CAN controller.</p>
<p>The MCP2515 is able the define 6 filters. For example :</p>
<pre><code class="language-javascript">CAN.init_Filt(0, 0, 0x04);                          
CAN.init_Filt(1, 0, 0x05);                          
</code></pre>
<p>This code means that the CAN controller will only listen to the messages with an ID of 0x04 and 0x05.</p>
<a class="header" href="electronics/communication/can.html#masks" id="masks"><h4>Masks</h4></a>
<p>The masks defines the bits that will be inspected to filter the coming ID. If the bit of the mask is 1, it means that the ID has to respect the bit of the filter.</p>
<p>For example with the following filter :</p>
<pre><code class="language-javascript">0100 1101
</code></pre>
<p>If the mask is :</p>
<pre><code class="language-javascript">1111 1111
</code></pre>
<p>Then it means that the accepted ID has to have exactly the same bits thant the filter because all the masks bits are 1. Only a message witch the next ID will be accepted :</p>
<pre><code class="language-javascript">0100 1101
</code></pre>
<p>Now, if the mask is this one :</p>
<pre><code class="language-javascript">1111 1110
</code></pre>
<p>It means that the filter will not inspect the last bit of the ID.</p>
<p>The next ID's will be accpeted</p>
<pre><code class="language-javascript">0100 1100
0100 1101
</code></pre>
<a class="header" href="electronics/communication/can.html#usefull-links" id="usefull-links"><h1>Usefull links</h1></a>
<ul>
<li>Introduction to CANBus by Texas Instrument, <a href="http://www.ti.com/lit/an/sloa101b/sloa101b.pdf">http://www.ti.com/lit/an/sloa101b/sloa101b.pdf</a></li>
<li>CAN specs by BOSCH, <a href="https://www.kvaser.com/software/7330130980914/V1/can2spec.pdf">https://www.kvaser.com/software/7330130980914/V1/can2spec.pdf</a></li>
<li>CANBus implementation with Arduino, <a href="http://www.prometec.net/wp-content/uploads/2015/07/Controller-Area-Network-Prototyping-With-Arduino-Wilfried-Voss.pdf">http://www.prometec.net/wp-content/uploads/2015/07/Controller-Area-Network-Prototyping-With-Arduino-Wilfried-Voss.pdf</a></li>
<li>Well documented on Wikipedia, https://en.wikipedia.org/wiki/CAN_bus</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="electronics/communication/spi.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="software/software.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="electronics/communication/spi.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="software/software.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        

        
        <script src="searchindex.js" type="text/javascript" charset="utf-8"></script>
        
        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

    </body>
</html>
